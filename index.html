<script>
    console.log('=== 脚本开始执行 ===');

    // 从 URL 参数中获取值
    function getUrlParameter(name) {
        console.log('调用 getUrlParameter，参数名 =', name);
        const urlParams = new URLSearchParams(window.location.search);
        const value = urlParams.get(name);
        console.log('getUrlParameter 返回：', value);
        return value;
    }

    // 更新状态信息
    function updateStatus(message) {
        const el = document.getElementById('status');
        if (el) el.textContent = message;
        console.log('[status]', message);
    }

    // 获取 URL 中的目标网址参数
    let targetUrl = getUrlParameter('url');

    // 这里改成你的 n8n Webhook “生产地址”（必须是公网能访问的）
    // 示例：http://121.40.230.182:5678/webhook/feishu-redirect
    const n8nWebhookUrl = 'http://121.40.230.182:5678/webhook/feishu-redirect';

    console.log('获取到的 targetUrl =', targetUrl);

    if (!targetUrl) {
        console.log('进入：!targetUrl 分支');
        updateStatus('错误：未提供目标网址参数 ?url=');
    } else {
        console.log('进入：有 targetUrl 的分支');

        // 确保网址有协议头
        if (!targetUrl.startsWith('http://') && !targetUrl.startsWith('https://')) {
            targetUrl = 'https://' + targetUrl;
        }

        console.log('最终要提交到 n8n 的 targetUrl =', targetUrl);
        updateStatus('开始发送到 n8n Webhook（中转到飞书）...');

        // 通过 GET + query 参数 name 调用 n8n
        const fullUrl = n8nWebhookUrl + '?name=' + encodeURIComponent(targetUrl);
        console.log('准备执行 fetch 到 n8n：', fullUrl);

        fetch(fullUrl, {
            method: 'GET',
            mode: 'no-cors' // 避免 CORS 报错（重要）
        })
        .then(() => {
            console.log('fetch 调用已发送（no-cors 模式，看不到状态码）');
            updateStatus('已发送到 n8n（浏览器 no-cors 模式无法看到结果），即将跳转...');
            // 1～2秒后跳转到真正目标网站
            setTimeout(() => {
                window.location.href = targetUrl;
            }, 1500);
        })
        .catch(error => {
            // 注意：no-cors 下其实不会进到 catch，这里只是兜底
            updateStatus('请求 n8n 失败（可能被浏览器拦截）: ' + error.message);
            console.error('Webhook 错误详情:', error);
        });
    }

    console.log('=== 脚本结尾 ===');
</script>
